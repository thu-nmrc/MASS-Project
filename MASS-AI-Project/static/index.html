<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- æ·»åŠ favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%233498db'/%3E%3C/svg%3E" type="image/svg+xml">
<title>å¤šæ™ºèƒ½ä½“ç¤¾ä¼šæ¨¡æ‹Ÿï¼ˆMASSï¼‰å¹³å°</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
:root{--bg:#0b0f14;--panel:#121821;--line:#223044;--muted:#93a4b7}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e141d);color:#e6eef8}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(12,18,28,.8);backdrop-filter:blur(6px)}
main{padding:14px;display:grid;grid-template-columns:60% 40%;gap:14px}
section{background:#121821;border:1px solid var(--line);border-radius:12px;padding:12px}
h1{font-size:18px;margin:0}
.muted{color:var(--muted);font-size:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2b3a50;background:#0f1520;color:#e6eef8}
textarea{min-height:110px;resize:vertical}
button{padding:8px 10px;border-radius:10px;border:1px solid #2b3a50;background:#132033;color:#e6eef8;cursor:pointer}
button:hover{border-color:#395376}
.btn-ok{background:#124d2f;border-color:#1b6b42}
.btn-warn{background:#4a390f;border-color:#8a6d1a}
.btn-danger{background:#4a1010;border-color:#8a1a1a}
.table-wrap{height:430px;overflow:auto;border:1px solid var(--line);border-radius:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:12px;vertical-align:top}
th{position:sticky;top:0;background:#101828;z-index:1}
.agent-card{border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin-bottom:8px;background:#0f1520}
.pill{display:inline-block;padding:2px 8px;border:1px solid #2b3a50;border-radius:999px;background:#101828}
.small{font-size:12px}
.right{display:flex;gap:8px;align-items:center}
pre.block{white-space:pre-wrap;border:1px solid #2b3a50;background:#0f1520;border-radius:8px;padding:10px}
</style>
</head>
<body>
<header>
  <div>
    <h1>MASS æ¨¡æ‹Ÿå™¨ Â· v15.2</h1>
    <div class="muted">UI åªå¡«ç›®æ ‡ Base URLï¼›æ‰€æœ‰è°ƒç”¨èµ°æœ¬åœ° /api è½¬å‘ï¼ˆé¿å… CORSï¼‰ã€‚</div>
  </div>
  <div class="right"><span class="small" id="usageLine">tokens: 0</span></div>
</header>

<main ondragover="handleDragOver(event)" ondrop="handleDrop(event)" >
  <section>
    <h3>åŸºæœ¬è®¾ç½®</h3>
    <!-- ç¡®ä¿æ—¶é—´ç²’åº¦ä¸‹æ‹‰èœå•å·²å­˜åœ¨ï¼ˆå·²åœ¨ç°æœ‰ä»£ç ä¸­å­˜åœ¨ï¼‰-->
    <div class="row grid2">
      <div>
        <label>æ—¶é—´ç²’åº¦</label>
        <select id="granularity">
          <option value="day">æ—¥</option>
          <option value="week" selected>å‘¨</option>
          <option value="month">æœˆ</option>
          <option value="quarter">å­£</option>
          <option value="year">å¹´</option>
        </select>
      </div>
      <div>
        <label>èµ·å§‹æ—¥æœŸ</label>
        <input id="startDate" type="date"/>
      </div>
    </div>
    <div class="row grid2">
      <div><label>å›åˆä¸Šé™</label><input id="maxSteps" type="number" value="8" min="1"/></div><div></div>
    </div>

    <div class="row">
      <label>èƒŒæ™¯è§„åˆ™</label>
      <textarea id="bgRules" placeholder="å†™æ¸…æ”¿ç­–å£å¾„/ä»·æ ¼ç²¾åº¦/ä¿¡æ¯å¯è§æ€§/ç»“æ„...ï¼ˆä¼šä½œä¸ºã€èƒŒæ™¯ã€‘æ‹¼æ¥ï¼‰"></textarea>
    </div>
    <div class="row"><label><input id="bgEveryStep" type="checkbox"/> æ¯å›åˆéƒ½å‘é€èƒŒæ™¯</label></div>

    <h3>Agent</h3>
    <div class="row"><input id="agentName" placeholder="Agent åç§°"/></div>
    <div class="row"><input id="agentPromptExtra" placeholder="ä¸´æ—¶æç¤ºè¯ï¼ˆå¯é€‰ï¼‰ï¼šå½“å›åˆçš„é¢å¤–æé†’ï¼Œä¼šæ‹¼æ¥åˆ°è¯¥ Agent çš„ Prompt ä¹‹å" style="border: 1px dashed #2b3a50; background: #0b1018; color: #93a4b7;"/></div>
    <div class="row"><textarea id="agentPrompt" placeholder="Promptï¼šè¿™ä¸ª Agent æ˜¯è°ã€å¦‚ä½•å†³ç­–/åå¥½ï¼ˆå¿…é¡»è‡ªæ´½ç‹¬ç«‹ï¼Œä¸å¼•ç”¨ä»–äººï¼‰"></textarea></div>
    <div class="row"><label><input id="multiApi" type="checkbox"/> å¯ç”¨å¤š API æ¨¡å¼ï¼ˆå¯ä¸ºéƒ¨åˆ† Agent è®¾ç‹¬ç«‹ APIï¼‰</label></div>
    <div class="row">
      <button id="addAgent" class="btn-ok">+ æ·»åŠ  Agent</button>
      <span class="small" id="agentCount">0</span>
    </div>
    <div id="agentList"></div>

    <h3>èƒ¶å›Šç®¡ç†ï¼ˆCapsule Managementï¼‰</h3>
    <div class="row">
      <button id="refreshCapsuleStatus" class="btn-ok">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
      <button id="clearAllCapsules" class="btn-warn">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰ç¼“å­˜</button>
      <span class="small" id="capsuleStatusCount">0 ä¸ª Agent æœ‰å›å¡«æ•°æ®</span>
    </div>
    <div id="capsuleStatusList" style="margin-top: 10px;"></div>

    <h3>æ”¿ç­–äº‹ä»¶ï¼ˆPolicy Eventsï¼‰</h3>
    <div class="row">
      <button id="addPolicyEvent" class="btn-ok">+ æ·»åŠ äº‹ä»¶</button>
      <span class="small" id="policyEventCount">0</span>
    </div>
    <div id="policyEventList"></div>

    <h3>æ¨¡å‹/æ¥å£ï¼ˆå…¨å±€ APIï¼‰</h3>
    <div class="row grid2">
      <div><label>Base URLï¼ˆç›®æ ‡ç½‘ç«™ï¼‰</label><input id="baseUrl" placeholder="å¦‚ https://aihubmix.com/v1"/></div>
      <div><label>æ¨¡å‹å</label><input id="modelName" placeholder="gpt-5 / deepseek-chat / qwen-plus â€¦"/></div>
    </div>
    <div class="row grid2">
      <div><label>API Key</label><input id="apiKey" type="password" placeholder="sk-..."/></div>
      <div></div>
    </div>
    <!-- ç§»é™¤max_tokensç›¸å…³è®¾ç½®ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜ -->
    <div class="row grid2">
      <div><label>æœ€å¤§Tokenæ•°</label><input id="maxTokens" type="number" min="1" max="8192" value="512"/></div>
      <div></div> <!-- ç§»é™¤temperatureè¾“å…¥æ¡† -->
    </div>
      <div></div>
      <div class="right"><button id="btnSaveCfg" class="btn-ok">ä¿å­˜è®¾ç½®</button><button id="btnTest" type="button">æµ‹è¯•è¿æ¥</button><span id="probe" class="small muted"></span></div>
    </div>
    


    <details style="margin-top:10px">
      <summary>Tokens & é¢„ç®—ï¼ˆå¯é€‰ï¼Œä¸å½±å“å†³ç­–ï¼‰</summary>
      <div class="row grid2">
        <div><label><input id="onlyJson" type="checkbox" checked/> ä»…è¾“å‡º JSONï¼ˆçŸ­é”®ï¼ša/r/o/m/logï¼‰</label></div>
        <div><label>æ€» token ä¸Šé™</label><input id="tokenCap" type="number" placeholder="å¦‚ 20000"/></div>
      </div>
    </details>

    <h3 style="margin-top:10px">è¿è¡Œ</h3>
    <div class="row"><button id="btnPreview">ğŸ” é¢„è§ˆæœ¬å›åˆæç¤º</button></div>
    <div class="row" id="btnBar" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <button id="btnStart" style="grid-column:1/3;height:46px;font-size:16px">å¼€å§‹</button>
      <button id="btnPause" class="btn-warn" style="display:none">æš‚åœ</button>
      <button id="btnStop" class="btn-danger" style="display:none">åœæ­¢</button>
      <button id="btnContinue" class="btn-ok" style="display:none">ç»§ç»­</button>
    </div>
  </section>

  <section>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h3>æ¶ˆæ¯è¡¨</h3><div class="muted small">è®°å½•ï¼šå›åˆã€æ—¶é—´ã€ä¸»ä½“ã€äº‹ä»¶ã€æ‘˜è¦/å˜æ›´</div></div>
      <div class="right">
        <input type='file' id='importFile' accept='.json,application/json' style='display:none'>
<span style="margin-left:8px;font-size:12px;opacity:.7;">æˆ–</span> <input id="importFileVisible" type="file" accept="application/json,.json" title="è‹¥æŒ‰é’®è¢«æµè§ˆå™¨æ‹¦æˆªï¼Œè¯·ç›´æ¥ç”¨æ­¤è¾“å…¥é€‰æ‹© JSON æ–‡ä»¶" style="font-size:12px;padding:4px 6px;border-radius:6px;border:1px solid #334; background:#111; color:#cfd7e6;" />
        <button id='btnImport' class='btn'>å¯¼å…¥é…ç½®ï¼ˆJSONï¼‰</button>
        <button id="btnDownloadCSV">ä¸‹è½½ç»“æœï¼ˆCSVï¼‰</button>
        <button id="btnDownloadChatLog">å¯¼å‡ºå¯¹è¯æ—¥å¿—ï¼ˆExcelï¼‰</button>
        <button id="btnDownloadBundle">ä¸‹è½½é…ç½®ï¼ˆJSON æ‰“åŒ…ï¼‰</button>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th style="width:70px">å›åˆ</th><th style="width:120px">æ—¶é—´</th><th style="width:160px">ä¸»ä½“</th><th style="width:140px">äº‹ä»¶</th><th>æ‘˜è¦ / å˜æ›´</th></tr></thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </section>

<section>
  <h3 style="margin:6px 0;">é”™è¯¯ / è°ƒè¯•</h3>
  <div class="row">
    <button id="btnCopyErr">å¤åˆ¶</button>
    <button id="btnClearErr">æ¸…ç©º</button>
  </div>
  <pre id="errConsole" style="white-space:pre-wrap;background:#0b1018;border:1px solid #223044;padding:10px;height:180px;overflow:auto;border-radius:8px;"></pre>
</section>

</main>

<div id="preview" style="position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.5);z-index:50">
  <div class="panel" style="width:min(920px,96vw);max-height:92vh;overflow:auto;background:#0f1520;border:1px solid var(--line);border-radius:12px;padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center"><h3>é¢„è§ˆ</h3><button onclick="document.querySelector('#preview').style.display='none'">âœ•</button></div>
    <div id="previewBody"></div>
  </div>
</div>

<!-- å¼•å…¥å¤–éƒ¨JSæ–‡ä»¶ -->
<script src="/static/js/utils.js" defer></script>
<script src="/static/js/error-console.js" defer></script>
<script src="/static/js/settings.js" defer></script>
<script src="/static/js/io.js" defer></script>
<script src="/static/js/capsule.js" defer></script>
<script src="/static/js/network.js" defer></script>
<script src="/static/js/agents.js" defer></script>
<script src="/static/js/simulation.js" defer></script>
<script src="/static/js/controls.js" defer></script>
<script src="/static/js/app.js" defer></script>

<script>
// UIçŠ¶æ€åŒæ­¥å‡½æ•°
function readUIToStateBasics() {
  if (!window.state) window.state = {};
  if (!window.state.settings) window.state.settings = {};
  if (!window.state.sim) window.state.sim = {};
  
  const settings = window.state.settings;
  const sim = window.state.sim;
  
  // è¯»å–APIè®¾ç½®
  const baseUrl = document.querySelector('#baseUrl');
  const apiKey = document.querySelector('#apiKey');
  const modelName = document.querySelector('#modelName');
  const maxTokens = document.querySelector('#maxTokens');
  const multiApi = document.querySelector('#multiApi');
  
  if (baseUrl) settings.baseUrl = baseUrl.value.trim();
  if (apiKey) settings.apiKey = apiKey.value.trim();
  if (modelName) settings.modelName = modelName.value.trim();
  if (maxTokens) settings.maxTokens = Number(maxTokens.value) || 512;
  if (multiApi) settings.multiApi = multiApi.checked;
  
  // è¯»å–æ¨¡æ‹Ÿè®¾ç½®
  const granularity = document.querySelector('#granularity');
  const startDate = document.querySelector('#startDate');
  const maxSteps = document.querySelector('#maxSteps');
  const bgRules = document.querySelector('#bgRules');
  
  if (granularity) sim.granularity = granularity.value;
  if (startDate) sim.startDate = startDate.value;
  if (maxSteps) sim.maxSteps = Number(maxSteps.value) || 8;
  if (bgRules) {
    sim.bgRules = bgRules.value;
    window.state.backgroundText = bgRules.value;
  }
}

function writeStateToUIBasics() {
  if (!window.state) return;
  
  const settings = window.state.settings || {};
  const sim = window.state.sim || {};
  
  // å†™å…¥APIè®¾ç½®
  const baseUrl = document.querySelector('#baseUrl');
  const apiKey = document.querySelector('#apiKey');
  const modelName = document.querySelector('#modelName');
  const maxTokens = document.querySelector('#maxTokens');
  const multiApi = document.querySelector('#multiApi');
  
  if (baseUrl && settings.baseUrl) baseUrl.value = settings.baseUrl;
  if (apiKey && settings.apiKey) apiKey.value = settings.apiKey;
  if (modelName && settings.modelName) modelName.value = settings.modelName;
  if (maxTokens && settings.maxTokens != null) maxTokens.value = settings.maxTokens;
  if (multiApi && settings.multiApi != null) multiApi.checked = settings.multiApi;
  
  // å†™å…¥æ¨¡æ‹Ÿè®¾ç½®
  const granularity = document.querySelector('#granularity');
  const startDate = document.querySelector('#startDate');
  const maxSteps = document.querySelector('#maxSteps');
  const bgRules = document.querySelector('#bgRules');
  
  if (granularity && sim.granularity) granularity.value = sim.granularity;
  if (startDate && sim.startDate) startDate.value = sim.startDate;
  if (maxSteps && sim.maxSteps != null) maxSteps.value = sim.maxSteps;
  if (bgRules && (sim.bgRules || window.state.backgroundText)) {
    bgRules.value = sim.bgRules || window.state.backgroundText || '';
  }
}

    // æš´éœ²åˆ°å…¨å±€
    window.readUIToStateBasics = readUIToStateBasics;
    window.writeStateToUIBasics = writeStateToUIBasics;
    </script>
    
    <!-- ä¿®å¤ï¼šå°†èƒ¶å›Šç®¡ç†è„šæœ¬æ”¾åˆ° body é—­åˆå‰ï¼Œå¹¶ç”¨ <script> åŒ…è£¹ -->
    <script>
    // èƒ¶å›Šç®¡ç†åŠŸèƒ½
    function renderCapsuleStatus() {
      const statusList = document.querySelector('#capsuleStatusList');
      const statusCount = document.querySelector('#capsuleStatusCount');
      if (!statusList || !statusCount) return;
      
      const status = window.getCapsuleStatus ? window.getCapsuleStatus() : {};
      const agentIds = Object.keys(status);
      const hasDataCount = agentIds.filter(id => status[id].hasData).length;
      
      statusCount.textContent = `${hasDataCount} ä¸ª Agent æœ‰å›å¡«æ•°æ®`;
      
      if (agentIds.length === 0) {
        statusList.innerHTML = '<div class="small muted">æš‚æ— èƒ¶å›Šæ•°æ®</div>';
        return;
      }
      
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:120px;">Agent ID</th>
            <th style="width:80px;">çŠ¶æ€</th>
            <th style="width:100px;">æœ€åå›åˆ</th>
            <th style="width:150px;">æ•°æ®é”®</th>
            <th style="width:180px;">æœ€åæ›´æ–°</th>
            <th style="width:80px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      
      const tbody = table.querySelector('tbody');
      agentIds.forEach(agentId => {
        const data = status[agentId];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${agentId}</td>
          <td>${data.hasData ? 'âœ… æœ‰æ•°æ®' : 'âŒ æ— æ•°æ®'}</td>
          <td>${data.lastRound || '-'}</td>
          <td title="${data.dataKeys.join(', ')}">${data.dataKeys.slice(0, 3).join(', ')}${data.dataKeys.length > 3 ? '...' : ''}</td>
          <td class="small">${data.lastUpdate ? new Date(data.lastUpdate).toLocaleString() : '-'}</td>
          <td><button class="btn-danger small" onclick="clearSingleAgentCapsule('${agentId}')">æ¸…ç©º</button></td>
        `;
        tbody.appendChild(tr);
      });
      
      statusList.innerHTML = '';
      statusList.appendChild(table);
    }

    function clearSingleAgentCapsule(agentId) {
      if (confirm(`ç¡®å®šè¦æ¸…ç©º Agent ${agentId} çš„å›å¡«ç¼“å­˜å—ï¼Ÿ`)) {
        if (window.clearAgentCapsule) {
          window.clearAgentCapsule(agentId);
          renderCapsuleStatus();
        }
      }
    }

    function clearAllCapsules() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ Agent çš„å›å¡«ç¼“å­˜å—ï¼Ÿ')) {
        if (window.agentCapsuleData) {
          window.agentCapsuleData = {};
          renderCapsuleStatus();
          console.log('å·²æ¸…ç©ºæ‰€æœ‰èƒ¶å›Šç¼“å­˜');
        }
      }
    }

    // ç»‘å®šèƒ¶å›Šç®¡ç†æŒ‰é’®äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      const refreshBtn = document.querySelector('#refreshCapsuleStatus');
      const clearAllBtn = document.querySelector('#clearAllCapsules');
      
      if (refreshBtn) {
        refreshBtn.addEventListener('click', renderCapsuleStatus);
      }
      
      if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllCapsules);
      }
      
      // åˆå§‹æ¸²æŸ“
      setTimeout(renderCapsuleStatus, 100);
    });
    </script>
    
    </body>
    </html>
